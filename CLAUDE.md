# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Interactive redistricting/gerrymandering simulator. Users paint congressional districts on a hex-tile map and observe how boundary placement affects electoral outcomes in real time. Zero dependencies — vanilla HTML/CSS/JS with SVG rendering.

## Running Locally

No build step. Serve with any static HTTP server:
```bash
python -m http.server 8000
# or
npx serve .
```
Open `http://localhost:8000`. There is no package.json, no test suite, and no linter configured.

## Architecture

Four files: `colors.js` (~150 lines), `index.html` (~355 lines), `script.js` (~1555 lines), `styles.css` (~1230 lines).

### Color System (colors.js)

Single source of truth for all colors and fonts, loaded before `styles.css` in `<head>`. Exposes three globals:
- **`_r(hex, alpha)`**: alpha helper — appends 2-digit hex alpha to a color string
- **`_FONT`**: frozen object with `heading`, `body`, `mono` font stacks
- **`_PALETTE`**: frozen object with `light` and `dark` sub-objects, each containing:
  - Surface colors: `canvas`, `panelSolid`, `elevated`
  - Text: `text`, `textSecondary`, `textMuted`
  - Accent: `accent`, `accentLight`
  - Party colors (frozen sub-objects): `red`, `blue`, `yellow`, `none` — each with `{ base, dark, light, muted, district }`
  - `green` (minority marker, single hex string)

An IIFE injects `<style id="palette-vars">` into `<head>` with all CSS custom properties (`:root`/`[data-theme="light"]` and `[data-theme="dark"]`). Layout-only tokens (`--radius-*`, `--toolbar-h`, `--panel-w`, `--ease-*`, `color-scheme`) remain in `styles.css`.

In `script.js`, `activeColors` points to `_PALETTE.light` or `_PALETTE.dark` (swapped in `syncTheme()`). Party colors in CSS are accessed via `var(--party-red)` etc.; in JS via `activeColors.red.base`, `.dark`, etc.

### State Management (script.js)

All application state lives in a single `state` object:
- `hexes` (Map): hex tiles keyed by `"q,r"` axial coordinates, each storing population, party votes, district assignment, and demographic data
- `districts` (Object): 10 districts with computed metrics (population, votes, winner, compactness, contiguity)
- Undo/redo stacks (50-level deep snapshots of hex→district assignments)
- Viewport state (viewBox, zoomLevel, pan position)

### Data Flow

```
User input (mouse/keyboard) → Paint/Erase/Zoom handler → Mutate state
→ recalculate metrics & winners → re-render SVG + sidebar → push undo snapshot
```

### Layout

Map-first floating-panel layout (not sidebar-based):
- **Intro screen**: themed splash with instruction cards and CTA, dismissed on click
- **Toolbar**: fixed glass bar at top (12px inset) with tool buttons; title uses `<em>` for italic accent-gradient second word
- **Map**: full-viewport SVG canvas (`<main>` is `position: fixed; inset: 0`)
- **District palette**: fixed pill-shaped bar at bottom center with plain text numbers (active = bold + accent color, assigned = party color text)
- **Stats panel**: toggleable floating panel (right side, extends to bottom edge; bottom sheet on mobile ≤900px)
- **Zoom controls**: floating left side, extends to bottom edge
- Entrance animations gated by `.app-ready` class added to `<body>` when intro is dismissed

### Key Algorithms

- **Hex grid**: Axial coordinate system (q, r, s). `hexToPixel()` / `hexCorners()` convert to SVG positions. Grid is ~18×25 hexes with an organic boundary generated by trigonometric noise.
- **Population generation**: Gaussian decay from randomly placed cities/towns. Three density tiers: urban (pop > 150, leans Blue ~70%), suburban (80–150, leans Red ~62%), rural (≤80, leans Red ~76%). Yellow is a third party (~8–10%). Target overall split is ~45-45-10 R-B-Y.
- **Efficiency gap**: Wasted-vote analysis (Red vs Blue only). Positive = favors Blue, negative = favors Red.
- **Compactness**: Polsby-Popper method (4π × area / perimeter²).
- **Contiguity**: BFS flood-fill from an arbitrary hex in each district; valid if all district hexes are reachable.
- **District borders**: Extract boundary edges between differently-assigned hexes, chain into continuous SVG paths, clip to district regions.

### Performance Patterns (script.js)

- **`$` object**: cached DOM element references — always use `$.elementName` instead of `document.getElementById()` in hot paths
- **`hexElements` Map**: maps `"q,r"` keys to SVG `<g>` elements — use instead of `querySelector('.hex[data-qr="..."]')`
- **Precomputed constants**: `SQRT3`, `HEX_W`, `HEX_H`, `HEX_CORNER_OFFSETS`, `HEX_DIRS` — avoid recalculating geometry
- **No per-hex event listeners**: SVG-level listeners handle all hex interaction via event bubbling and `getHexFromEvent()`
- **`scheduleBorderUpdate()`**: throttles border re-rendering to one `requestAnimationFrame` per paint stroke

### Styling (styles.css)

All color/font CSS custom properties are injected by `colors.js` (see Color System above). `styles.css` contains only layout tokens and component styles. Light/dark themes with warm cream (#F0EDE4) / near-black (#0C0B09) canvases. Terracotta accent (#D97757). Party colors: Red (#C42838), Blue (#1A54B0), Yellow (#B88A00). Glass-morphism panels with `backdrop-filter`. Typography: Instrument Serif (headings), Sora (sidebar/section headers, uppercase), Geist (body), Geist Mono (data). Fonts loaded via `<link>` in HTML — do NOT add duplicate `@import` in CSS.

### User Interactions

- Left-click: assign hex to current district (with 110% population cap)
- Right-click: erase hex assignment
- Erase mode: toggle button for single-hex erasure
- Scroll wheel: zoom (0.3x–1.5x viewbox, clamped via `clampViewBox()`)
- Middle-click drag: pan (clamped to half-viewport beyond map bounds)
- Touch: single-finger paint, two-finger pinch-to-zoom and pan (same clamps)
- Ctrl+Z / Ctrl+Y: undo/redo
- Delete mode: toggle button for bulk district erasure
- District palette: click numbered buttons to select active district
- Stats toggle: show/hide analysis panel (auto-opens on desktop >900px)

## Related Projects

`~/Documents/antigravity/biosim` — sibling project with shared design language (Sora uppercase headers, warm palette). Reference for styling conventions.
