# CLAUDE.md

Part of the **a9l.im** portfolio. See parent `site-meta/CLAUDE.md` for the shared design system specification. Sibling projects: `physsim`, `biosim`.

## Overview

Interactive redistricting/gerrymandering simulator. Users paint congressional districts on a hex-tile map and observe how boundary placement affects electoral outcomes in real time. Zero dependencies — vanilla HTML/CSS/JS with SVG rendering.

## Running Locally

```bash
python -m http.server 8000
# or
npx serve .
```

No package.json, no test suite, no linter configured.

## Architecture

ES6 modules loaded via `<script type="module" src="main.js">`. Non-module `colors.js` loads in `<head>` to freeze `_PALETTE` before modules run. Loads `/shared-tokens.js` and `/shared-base.css` from the root site.

```
main.js                 — Entry point: imports, DOM cache ($), init, setupUI()
src/
  config.js             — CONFIG, hex geometry constants, EASE_OUT
  hex-math.js           — hexToPixel, hexCorners, hexDistance, getHexFromPoint
  noise.js              — hashNoise, smoothNoise, fbmNoise
  hex-generator.js      — generateHexes (population, votes, minority)
  state.js              — state object, initDistricts, undo/redo, snapshot
  metrics.js            — compactness, contiguity, efficiency gap (pure functions)
  renderer.js           — renderMap, renderBorders, renderDistrictLabels, hex visuals
  input.js              — mouse handlers, painting logic, hover/tooltip
  touch.js              — pinch-zoom, pan, touch-paint
  zoom.js               — wheel zoom, smooth zoom, zoomToFit, animateViewBox
  sidebar.js            — updateMetrics UI, proportionality display
  palette.js            — district palette rendering, mode management
  theme.js              — initTheme, syncTheme, toggleTheme
```

### Color System (colors.js)

Extends `shared-tokens.js` with project-specific party colors referencing `_PALETTE.extended.*`:

| Party | `_PALETTE` key | Extended source |
|-------|---------------|-----------------|
| Red | `red` | `extended.rose` |
| Blue | `blue` | `extended.blue` |
| Yellow | `yellow` | `extended.orange` |
| None | `none` | `extended.slate` |
| Green (minority) | `green` | `extended.green` |

An IIFE injects `<style id="project-vars">` with themed CSS vars: `--party-*` (with `-tint`/`-wash` variants), `--tip-*`, `--hex-stroke`, `--tooltip-bg/fg`, `--bar-track`. Light theme darkens party colors via `_darken()` (from `shared-tokens.js`); dark theme uses base colors directly.

In `src/theme.js`, `activeColors` points to `_PALETTE.light` or `_PALETTE.dark` (swapped in `syncTheme()`). Party colors in CSS via `var(--party-red)` etc.; in JS directly as `_PALETTE.red` (plain hex strings). Darker variants computed on the fly via `_darken()`.

### State Management (src/state.js)

All application state lives in a single `state` object:
- `hexes` (Map): hex tiles keyed by `"q,r"` axial coordinates, each storing population, party votes, district assignment, and demographic data
- `districts` (Object): 10 districts with computed metrics (population, votes, winner, compactness, contiguity)
- Undo/redo stacks (50-level deep snapshots of hex→district assignments)
- Viewport state (viewBox, zoomLevel, pan position)

### Data Flow

```
User input (mouse/keyboard) → Paint/Erase/Zoom handler → Mutate state
→ recalculate metrics & winners → re-render SVG + sidebar → push undo snapshot
```

### Key Algorithms

- **Hex grid**: Axial coordinate system (q, r, s). `hexToPixel()` / `hexCorners()` convert to SVG positions. Grid is ~18×25 hexes with an organic boundary generated by trigonometric noise.
- **Population generation**: Gaussian decay from randomly placed cities/towns. Three density tiers: urban (pop > 150, leans Blue ~70%), suburban (80–150, leans Red ~62%), rural (≤80, leans Red ~76%). Yellow is a third party (~8–10%). Target overall split is ~45-45-10 R-B-Y.
- **Efficiency gap**: Wasted-vote analysis (Red vs Blue only). Positive = favors Blue, negative = favors Red.
- **Compactness**: Polsby-Popper method (4π × area / perimeter²).
- **Contiguity**: BFS flood-fill from an arbitrary hex in each district; valid if all district hexes are reachable.
- **District borders**: Extract boundary edges between differently-assigned hexes, chain into continuous SVG paths, clip to district regions.

## UI & Layout

Map-first floating-panel layout:
- **Intro screen**: themed splash with instruction cards and CTA, dismissed on click
- **Toolbar** (`#toolbar.sim-toolbar`): fixed glass bar at top (12px inset) with tool buttons; title uses `<em>` for italic accent-gradient second word
- **Map**: full-viewport SVG canvas (`<main>` is `position: fixed; inset: 0`)
- **District palette**: fixed pill-shaped bar at bottom center with plain text numbers (active = bold + accent color, assigned = party color text)
- **Stats panel** (`#sidebar`): toggleable floating panel (right side; bottom sheet on mobile ≤900px). Internal sections use `.stat-group` / `.group-label` pattern (from `shared-base.css`). Data rows use `.stat-row` / `.stat-label` / `.stat-value`. Hint text uses `.panel-hint`.
- **Zoom controls**: floating left side, extends to bottom edge
- Entrance animations gated by `.app-ready` class added to `<body>` when intro is dismissed

### Responsive Breakpoints

- **1100px**: panel narrows to 320px
- **900px**: toolbar/palette shrink, sidebar becomes bottom sheet. Shared `shared-base.css` rules handle `--toolbar-h: 48px`, `.sim-toolbar` positioning, `.sim-brand` sizing, `.tool-sep` sizing. Project-specific: `.tool-btn` 36×36, palette/map-controls adjustments.
- **600px**: shared rules handle `.sim-brand`/`.sim-toolbar-actions`/`.tool-sep` further. Project-specific: `.tool-btn` 34×34, palette sizing.
- **440px**: shared `.hide-sm` hides non-essential elements. Project-specific: brand hidden, toolbar centered.

### User Interactions

- Left-click: assign hex to current district (with 110% population cap)
- Right-click: erase hex assignment
- Erase mode: toggle button for single-hex erasure
- Scroll wheel: zoom (0.3x–1.5x viewbox, clamped via `clampViewBox()`)
- Middle-click drag: pan (clamped to half-viewport beyond map bounds)
- Touch: single-finger paint, two-finger pinch-to-zoom and pan (same clamps)
- Ctrl+Z / Ctrl+Y: undo/redo
- Delete mode: toggle button for bulk district erasure
- District palette: click numbered buttons to select active district
- Stats toggle: show/hide analysis panel (auto-opens on desktop >900px)

## Key Patterns

### Performance

- **`$` object**: cached DOM element references in `main.js` — always use `$.elementName` instead of `document.getElementById()` in hot paths
- **All `getElementById` calls must live in the DOM cache block in `main.js`** — including buttons like `$.resetBtn`, `$.randomizeBtn`, `$.zoomInBtn`, `$.zoomOutBtn`, `$.zoomFitBtn`. Never use `getElementById` in `setupUI()` or event handlers.
- **`hexElements` Map**: maps `"q,r"` keys to SVG `<g>` elements — use instead of `querySelector('.hex[data-qr="..."]')`
- **Precomputed constants** in `src/config.js`: `SQRT3`, `HEX_W`, `HEX_H`, `HEX_CORNER_OFFSETS`, `HEX_DIRS` — avoid recalculating geometry
- **No per-hex event listeners**: SVG-level listeners handle all hex interaction via event bubbling and `getHexFromEvent()`
- **`scheduleBorderUpdate()`** in `src/renderer.js`: throttles border re-rendering to one `requestAnimationFrame` per paint stroke

### Helpers

- **`votePcts(votes)`** in `src/metrics.js`: returns `{ red, blue, yellow }` as raw percentages. Callers round as needed.
- **`shiftMapForSidebar()`** in `src/sidebar.js`: reads `--panel-w` from computed styles — no hardcoded pixel values.

### CSS Patterns

- **`.glass`** (from `shared-base.css`): applied to `#toolbar`, `#map-controls`, `#district-palette`, `#sidebar`. Override `box-shadow`/`transition` per-element as needed.
- **`.tool-btn`** (from `shared-base.css`): shared by toolbar buttons and map-ctrl-btn. Override `stroke-width: 2.5` on `#zoom-in-btn svg`, `#zoom-out-btn svg`, `#close-stats svg`.
- **Theme icons**: CSS-driven via `[data-theme="light"] .icon-sun` / `[data-theme="dark"] .icon-moon` — no JS needed.
- **`font-variant-numeric: tabular-nums`**: inherited from `.stats-scroll` and `#map-controls` — don't add individually to children.
- **Bar widths**: `.vote-bar, .prop-bar-fill { width: 0 }` in CSS — no inline `style="width: 0%"` needed in HTML.
- Project-specific override: `--palette-h: 56px`.

## Gotchas

- **No `@import` in CSS** — fonts are loaded via `<link>` in HTML. Duplicate `@import` in `styles.css` causes FOUC.
- **`data-theme="light"` must be on `<html>`** — CSS theme rules (icon visibility, color-scheme) depend on it before JS runs.
- **Media queries use `:root` only** — layout tokens (`--panel-w`, `--toolbar-h`) are not theme-specific. Don't add `[data-theme]` selectors in media queries.
- **Intro card SVGs keep their attributes** — `.tool-btn svg` defaults don't apply to intro cards. Those SVGs need explicit `fill="none" stroke="currentColor"` etc.
- **Shared CSS at domain root** — `shared-base.css` is loaded via `/shared-base.css` (absolute path). When serving locally, serve from the parent `a9lim.github.io/` directory or the shared file won't resolve.
