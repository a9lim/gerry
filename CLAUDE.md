# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Interactive redistricting/gerrymandering simulator. Users paint congressional districts on a hex-tile map and observe how boundary placement affects electoral outcomes in real time. Zero dependencies — vanilla HTML/CSS/JS with SVG rendering.

## Running Locally

No build step. Serve with any static HTTP server:
```bash
python -m http.server 8000
# or
npx serve .
```
Open `http://localhost:8000`. There is no package.json, no test suite, and no linter configured.

## Architecture

Four files: `colors.js` (~175 lines), `index.html` (~345 lines), `script.js` (~1675 lines), `styles.css` (~1190 lines).

### Color System (colors.js)

Single source of truth for all colors and fonts, loaded before `styles.css` in `<head>`. Exposes globals:
- **`_r(hex, alpha)`**: alpha helper — appends 2-digit hex alpha to a color string
- **`_parseHex`**, **`_rgb2hsl`**, **`_hsl2hex`**: HSL color math helpers (same as biosim's `enzymes.js`)
- **`_darken(hex)`**: derives a darker variant (`l * 0.7`) — used for district border strokes
- **`_FONT`**: frozen object with `heading`, `body`, `mono` font stacks
- **`_PALETTE`**: frozen object with `light` and `dark` sub-objects, each containing:
  - Surface colors: `canvas`, `panelSolid`, `elevated`
  - Text: `text`, `textSecondary`, `textMuted`
  - Accent: `accent`, `accentLight`
  - Party colors (plain hex strings): `red`, `blue`, `yellow`, `none`
  - `green` (minority marker, single hex string)

An IIFE injects `<style id="palette-vars">` into `<head>` with all CSS custom properties (`:root`/`[data-theme="light"]` and `[data-theme="dark"]`). Layout-only tokens (`--radius-*`, `--toolbar-h`, `--panel-w`, `--ease-*`, `color-scheme`) remain in `styles.css`.

In `script.js`, `activeColors` points to `_PALETTE.light` or `_PALETTE.dark` (swapped in `syncTheme()`). Party colors in CSS are accessed via `var(--party-red)` etc.; in JS directly as `activeColors.red` (plain hex strings). Darker variants are computed on the fly via `_darken()`.

### State Management (script.js)

All application state lives in a single `state` object:
- `hexes` (Map): hex tiles keyed by `"q,r"` axial coordinates, each storing population, party votes, district assignment, and demographic data
- `districts` (Object): 10 districts with computed metrics (population, votes, winner, compactness, contiguity)
- Undo/redo stacks (50-level deep snapshots of hex→district assignments)
- Viewport state (viewBox, zoomLevel, pan position)

### Data Flow

```
User input (mouse/keyboard) → Paint/Erase/Zoom handler → Mutate state
→ recalculate metrics & winners → re-render SVG + sidebar → push undo snapshot
```

### Layout

Map-first floating-panel layout (not sidebar-based):
- **Intro screen**: themed splash with instruction cards and CTA, dismissed on click
- **Toolbar**: fixed glass bar at top (12px inset) with tool buttons; title uses `<em>` for italic accent-gradient second word
- **Map**: full-viewport SVG canvas (`<main>` is `position: fixed; inset: 0`)
- **District palette**: fixed pill-shaped bar at bottom center with plain text numbers (active = bold + accent color, assigned = party color text)
- **Stats panel**: toggleable floating panel (right side, extends to bottom edge; bottom sheet on mobile ≤900px). Internal sections use `.stat-group` / `.group-label` pattern (shared with biosim's dashboard). Data rows use `.stat-row` / `.stat-label` / `.stat-value`. Hint text uses `.panel-hint` (italic, accent-subtle bg, accent-glow border).
- **Zoom controls**: floating left side, extends to bottom edge
- Entrance animations gated by `.app-ready` class added to `<body>` when intro is dismissed

**Responsive breakpoints:** 1100px (panel narrows to 320px), 900px (toolbar/palette shrink, sidebar becomes bottom sheet, `--panel-w` no longer shifts map), 600px (smaller toolbar text/buttons, stacked intro cards), 440px (brand hidden, theme toggle hidden via `.hide-sm`).

### Key Algorithms

- **Hex grid**: Axial coordinate system (q, r, s). `hexToPixel()` / `hexCorners()` convert to SVG positions. Grid is ~18×25 hexes with an organic boundary generated by trigonometric noise.
- **Population generation**: Gaussian decay from randomly placed cities/towns. Three density tiers: urban (pop > 150, leans Blue ~70%), suburban (80–150, leans Red ~62%), rural (≤80, leans Red ~76%). Yellow is a third party (~8–10%). Target overall split is ~45-45-10 R-B-Y.
- **Efficiency gap**: Wasted-vote analysis (Red vs Blue only). Positive = favors Blue, negative = favors Red.
- **Compactness**: Polsby-Popper method (4π × area / perimeter²).
- **Contiguity**: BFS flood-fill from an arbitrary hex in each district; valid if all district hexes are reachable.
- **District borders**: Extract boundary edges between differently-assigned hexes, chain into continuous SVG paths, clip to district regions.

### Performance Patterns (script.js)

- **`$` object**: cached DOM element references — always use `$.elementName` instead of `document.getElementById()` in hot paths
- **All `getElementById` calls must live in `cacheDOMElements()`** — including buttons like `$.resetBtn`, `$.randomizeBtn`, `$.zoomInBtn`, `$.zoomOutBtn`, `$.zoomFitBtn`. Never use `getElementById` in `setupUI()` or event handlers.
- **`hexElements` Map**: maps `"q,r"` keys to SVG `<g>` elements — use instead of `querySelector('.hex[data-qr="..."]')`
- **Precomputed constants**: `SQRT3`, `HEX_W`, `HEX_H`, `HEX_CORNER_OFFSETS`, `HEX_DIRS` — avoid recalculating geometry
- **No per-hex event listeners**: SVG-level listeners handle all hex interaction via event bubbling and `getHexFromEvent()`
- **`scheduleBorderUpdate()`**: throttles border re-rendering to one `requestAnimationFrame` per paint stroke

### Helpers (script.js)

- **`votePcts(votes)`**: returns `{ red, blue, yellow }` as raw percentages. Used by `showHexTooltip()` and `updateSidebarDetails()` — callers round as needed.
- **`shiftMapForSidebar()`**: reads `--panel-w` from computed styles — no hardcoded pixel values.

### Styling (styles.css)

All color/font CSS custom properties are injected by `colors.js` (see Color System above). `styles.css` contains only layout tokens and component styles. Light/dark themes with warm cream (#F0EDE4) / near-black (#0C0B09) canvases. Orange-red accent (#FE3B01). Party colors: Red (#C42838), Blue (#1A54B0), Yellow (#B88A00). Glass-morphism panels with `backdrop-filter`. Typography: Instrument Serif (headings), Sora (sidebar/section headers, uppercase), Geist (body), Geist Mono (data). Fonts loaded via `<link>` in HTML — do NOT add duplicate `@import` in CSS.

**Shared utilities:**
- **`.glass`**: shared backdrop-filter/background/border/box-shadow for `#toolbar`, `#map-controls`, `#district-palette`, `#sidebar`. Add this class in HTML; override `box-shadow`/`transition` per-element as needed.
- **`.tool-btn`**: shared by both toolbar buttons and map-ctrl-btn (zoom in/out/fit). `.map-ctrl-btn` is a small override for size/color. Add both classes in HTML for map controls.
- **`.tool-btn svg`**: provides `fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap/linejoin: round` defaults. No need for SVG presentation attributes on button icons in HTML. Override `stroke-width: 2.5` on `#zoom-in-btn svg`, `#zoom-out-btn svg`, `#close-stats svg`.
- **Theme icons**: CSS-driven via `[data-theme="light"] .icon-sun` / `[data-theme="dark"] .icon-moon` — no JS needed. `<html>` has `data-theme="light"` set in markup so icons work before JS.
- **`font-variant-numeric: tabular-nums`**: inherited from `.stats-scroll` and `#map-controls` — don't add individually to children.
- **Bar widths**: `.vote-bar, .prop-bar-fill { width: 0 }` in CSS — no inline `style="width: 0%"` needed in HTML.

### User Interactions

- Left-click: assign hex to current district (with 110% population cap)
- Right-click: erase hex assignment
- Erase mode: toggle button for single-hex erasure
- Scroll wheel: zoom (0.3x–1.5x viewbox, clamped via `clampViewBox()`)
- Middle-click drag: pan (clamped to half-viewport beyond map bounds)
- Touch: single-finger paint, two-finger pinch-to-zoom and pan (same clamps)
- Ctrl+Z / Ctrl+Y: undo/redo
- Delete mode: toggle button for bulk district erasure
- District palette: click numbered buttons to select active district
- Stats toggle: show/hide analysis panel (auto-opens on desktop >900px)

## Gotchas

- **No `@import` in CSS** — fonts are loaded via `<link>` in HTML. Duplicate `@import` in `styles.css` causes FOUC.
- **`data-theme="light"` must be on `<html>`** — CSS theme rules (icon visibility, color-scheme) depend on it before JS runs.
- **Media queries use `:root` only** — layout tokens (`--panel-w`, `--toolbar-h`) are not theme-specific. Don't add `[data-theme]` selectors in media queries.
- **Intro card SVGs keep their attributes** — `.tool-btn svg` defaults don't apply to intro cards. Those SVGs need explicit `fill="none" stroke="currentColor"` etc.

## Related Projects

`~/Documents/antigravity/biosim` — sibling project with shared design language (Sora uppercase headers, warm palette). Reference for styling conventions.
